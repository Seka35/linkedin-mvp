{% extends "base.html" %}

{% block content %}
<style>
    .campaign-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1) !important;
    }

    .lbl-detail {
        color: #5f6368;
        font-weight: 600;
        margin-right: 5px;
    }

    .icon-badge {
        display: inline-flex;
        align-items: center;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        border: 1px solid transparent;
    }

    .icon-new {
        background: #e8f0fe;
        color: #1967d2;
        border-color: #d2e3fc;
    }

    .icon-connected {
        background: #e6f4ea;
        color: #137333;
        border-color: #ceead6;
    }

    .icon-message {
        background: #feefc3;
        color: #b06000;
        border-color: #fdd663;
    }

    /* Modal Logs Specific */
    #logs-modal .modal-content {
        width: 90%;
        max-width: 800px;
        height: 70vh;
        max-height: 600px;
        background: #1e1e1e;
        color: #e0e0e0;
        border: 1px solid #444;
        display: flex;
        flex-direction: column;
        border-radius: 8px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
    }

    #logs-modal .modal-header {
        padding: 10px 15px;
        background: #252526;
        border-bottom: 1px solid #333;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #logs-modal .close-btn {
        color: #aaa;
        font-size: 1.5rem;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        line-height: 1;
    }

    #logs-modal .close-btn:hover {
        color: white;
    }

    #logs-terminal {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        font-size: 0.85rem;
        line-height: 1.4;
        white-space: pre-wrap;
        color: #4ec9b0;
    }
</style>

<div class="campaigns-page">
    <div class="header-actions">
        <h2>üéØ Campaigns</h2>
        <button class="btn-primary" onclick="showCreateCampaign()">+ New Campaign</button>
    </div>

    <!-- Creation Form (Hidden by default) -->
    <div id="create-campaign-form"
        style="display:none; margin: 20px 0; padding: 25px; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
        <h3 style="margin-top:0;">Create a Campaign</h3>
        <form id="campaign-form" style="display:flex; flex-direction:column; gap:15px;">
            <input type="text" name="name" placeholder="Campaign Name" required
                style="padding:10px; border:1px solid #ccc; border-radius:6px;">
            <input type="text" name="search_query" placeholder='Search Query (ex: "CEO Paris SaaS")' required
                style="padding:10px; border:1px solid #ccc; border-radius:6px;">
            <textarea name="first_message" placeholder="First message after connection/follow" rows="4" required
                style="padding:10px; border:1px solid #ccc; border-radius:6px;"></textarea>

            <div style="display:flex; gap:20px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <label>Delay (days):</label>
                    <input type="number" name="message_delay_days" value="3" min="0" max="30"
                        style="padding:8px; width:60px; border:1px solid #ccc; border-radius:6px;">
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <label>Limit/day:</label>
                    <input type="number" name="daily_limit" value="10" min="1" max="50"
                        style="padding:8px; width:60px; border:1px solid #ccc; border-radius:6px;">
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button type="submit" class="btn-primary">Create</button>
                <button type="button" onclick="document.getElementById('create-campaign-form').style.display='none'"
                    style="background:#f1f3f4; color:#333; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">Cancel</button>
            </div>
        </form>
    </div>

    <div class="campaigns-list">
        {% for campaign in campaigns %}
        <div class="campaign-card"
            style="display:flex; justify-content:space-between; align-items:stretch; margin-bottom: 25px; padding: 25px; border: 1px solid #e0e0e0; border-radius: 12px; background:white; width:100%; transition: box-shadow 0.2s;">

            <!-- Left Part: Info + Stats -->
            <div style="flex: 1; display:flex; flex-direction:column; justify-content:space-between;">

                <!-- Header Card -->
                <div>
                    <div style="display:flex; align-items:center; gap: 15px; margin-bottom: 8px;">
                        <h3 style="margin:0; font-size:1.4rem; color:#202124;">{{ campaign.name }}</h3>
                        <span class="badge badge-{{ campaign.status }}"
                            style="font-size: 0.75rem; text-transform:uppercase; letter-spacing:0.5px; border-radius:4px;">{{
                            campaign.status }}</span>
                        <span style="color:#5f6368; font-size: 0.85rem; margin-left:auto;">Created on {{
                            campaign.created_at.strftime('%m/%d/%Y') }}</span>
                    </div>

                    <!-- Horizontal Details -->
                    <div
                        style="display:flex; align-items:center; gap: 40px; font-size: 0.95rem; color: #3c4043; margin-top: 15px; border-bottom:1px solid #f0f0f0; padding-bottom:15px; margin-bottom:15px;">
                        <div style="flex:2;"><span class="lbl-detail">üîç Query:</span> {{ campaign.search_query }}</div>
                        <div style="flex:1;"><span class="lbl-detail">‚è± Delay:</span> {{ campaign.message_delay_days }}
                            days</div>
                        <div style="flex:1;"><span class="lbl-detail">‚ö° Limit:</span> {{ campaign.daily_limit }}/day
                        </div>
                    </div>
                </div>

                <!-- Horizontal Stats -->
                <div style="display: flex; gap: 15px; align-items:center;">
                    <div class="icon-badge icon-new" title="Targeted Prospects" style="flex:1; justify-content:center;">
                        üë• {{ campaign.stats_prospects }} targeted
                    </div>
                    <div class="icon-badge icon-connected" title="Connections sent"
                        style="flex:1; justify-content:center;">
                        ‚úÖ {{ campaign.stats_connected }} connected
                    </div>
                    <div class="icon-badge icon-message" title="Messages sent" style="flex:1; justify-content:center;">
                        üì® {{ campaign.stats_messaged }} messages
                    </div>
                </div>
            </div>

            <!-- Right Part: Actions -->
            <div
                style="flex: 0 0 160px; margin-left:30px; display:flex; flex-direction:column; gap: 10px; border-left:1px solid #f0f0f0; padding-left:20px; justify-content:center;">
                {% if campaign.status == 'active' %}
                <button onclick="runCampaign({{ campaign.id }})" class="btn-action"
                    style="width:100%; justify-content:center;">
                    ‚ñ∂Ô∏è Run
                </button>
                <button onclick="pauseCampaign({{ campaign.id }})" class="btn-action"
                    style="color: #ea8600; border-color: #ea8600; width:100%; justify-content:center;">
                    ‚è∏Ô∏è Pause
                </button>
                {% elif campaign.status == 'paused' %}
                <button onclick="resumeCampaign({{ campaign.id }})" class="btn-action"
                    style="color: #1a73e8; border-color: #1a73e8; width:100%; justify-content:center;">
                    ‚ñ∂Ô∏è Resume
                </button>
                {% endif %}

                <button onclick="openLogsModal({{ campaign.id }}, '{{ campaign.name|replace("'", "\\'") }}')"
                    class="btn-action"
                    style="color: #5f6368; border-color: #dadce0; width:100%; justify-content:center;">
                    üìú Logs
                </button>

                <button onclick="deleteCampaign({{ campaign.id }})" class="btn-action"
                    style="color: #d93025; border-color: #fce8e6; background:#fff; width:100%; justify-content:center; margin-top: auto;"
                    onmouseover="this.style.background='#fce8e6'" onmouseout="this.style.background='#fff'">
                    üóëÔ∏è Delete
                </button>
            </div>
        </div>
        {% else %}
        <div class="empty-state"
            style="text-align:center; padding:60px; color:#666; background:white; border-radius:12px;">
            <p style="font-size:1.2rem;">üì≠ No active campaigns.</p>
            <p>Create your first campaign to automate your outreach!</p>
            <button onclick="showCreateCampaign()" class="btn-primary" style="margin-top:20px;">Get Started</button>
        </div>
        {% endfor %}
    </div>
</div>

<!-- LOGS MODAL -->
<div id="logs-modal" class="modal-overlay" onclick="if(event.target === this) closeLogsModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="logs-modal-title" style="margin:0; font-size:1.2rem; font-family:sans-serif;">üìú Terminal Logs</h2>
            <button onclick="closeLogsModal()" class="close-btn">&times;</button>
        </div>
        <div class="modal-body" style="padding:0; display:flex; flex-direction:column; height:100%; overflow:hidden;">
            <div id="logs-terminal">
                Loading logs...
            </div>
        </div>
    </div>
</div>

<script>
    function showCreateCampaign() {
        document.getElementById('create-campaign-form').style.display = 'block';
        window.scrollTo(0, 0);
    }

    document.getElementById('campaign-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
            const res = await fetch('/api/campaigns', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) location.reload();
            else alert('Error: ' + data.error);
        } catch (err) { alert('Network Error'); }
    });

    async function runCampaign(id) {
        if (!confirm('Start scraping and actions now?')) return;
        await callApi(`/api/campaigns/${id}/run`, 'POST');
    }

    async function pauseCampaign(id) {
        if (!confirm('Pause this campaign?')) return;
        await callApi(`/api/campaigns/${id}/pause`, 'POST');
    }

    async function resumeCampaign(id) {
        await callApi(`/api/campaigns/${id}/resume`, 'POST');
    }

    async function deleteCampaign(id) {
        if (!confirm('‚ùå WARNING: Are you sure you want to delete this campaign?')) return;
        try {
            const res = await fetch(`/api/campaigns/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) location.reload();
            else alert('Deletion Error');
        } catch (e) { alert('Network Error'); }
    }

    let currentLogInterval = null;

    function openLogsModal(id, name) {
        const modal = document.getElementById('logs-modal');
        const title = document.getElementById('logs-modal-title');
        const terminal = document.getElementById('logs-terminal');

        title.textContent = `üìú Logs: ${name}`;
        terminal.textContent = "Connecting to logs...";
        modal.style.display = 'flex';

        loadLogs(id);
        if (currentLogInterval) clearInterval(currentLogInterval);
        currentLogInterval = setInterval(() => loadLogs(id), 2000);
    }

    function closeLogsModal() {
        document.getElementById('logs-modal').style.display = 'none';
        if (currentLogInterval) {
            clearInterval(currentLogInterval);
            currentLogInterval = null;
        }
    }

    async function loadLogs(id) {
        try {
            const res = await fetch(`/api/campaign/logs/${id}`);
            const data = await res.json();
            const terminal = document.getElementById('logs-terminal');

            const isScrolledToBottom = terminal.scrollHeight - terminal.scrollTop <= terminal.clientHeight + 50;
            terminal.textContent = data.logs || 'No logs available.';

            if (isScrolledToBottom) {
                terminal.scrollTop = terminal.scrollHeight;
            }
        } catch (e) { console.error("Logs error", e); }
    }

    async function callApi(url, method) {
        try {
            const res = await fetch(url, { method: method });
            const data = await res.json();
            if (data.success) location.reload();
            else alert('Error: ' + (data.error || 'Unknown'));
        } catch (e) { alert('Network Error'); }
    }
</script>
{% endblock %}