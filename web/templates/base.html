<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Automation MVP</title>
    <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}" type="image/png">
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- Mobile Header (Mobile Only) -->
    <div class="mobile-header">
        <a href="/">
            <img src="{{ url_for('static', filename='img/favicon.png') }}" alt="Logo">
        </a>
    </div>

    <!-- Top Navbar (Desktop Only) -->
    <nav class="navbar desktop-nav">
        <div class="container">
            <a href="/" class="logo-container"
                style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 10px;">
                <img src="{{ url_for('static', filename='img/favicon.png') }}" alt="Logo"
                    style="height: 32px; width: 32px; object-fit: contain;">
            </a>
            <ul>
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/prospects" class="nav-link">Prospects</a>
                <a href="/messages" class="nav-link">Messages</a>
                <a href="/campaigns" class="nav-link">Campaigns</a>
                <a href="/settings" class="nav-link">Settings</a>
            </ul>

            <!-- Account Switcher -->
            <div class="account-switcher" style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                {% if current_account %}
                <form action="/accounts/switch" method="POST" id="account-switch-form" style="margin:0;">
                    <select name="account_id" onchange="this.form.submit()"
                        style="padding: 5px; border-radius: 4px; border: 1px solid #ccc; background: white; color: #333;">
                        <option value="" disabled>Switch Account</option>
                        {% for acc in get_all_accounts() %}
                        <option value="{{ acc.id }}" {% if current_account.id==acc.id %}selected{% endif %}>
                            {{ acc.name or acc.email }}
                        </option>
                        {% endfor %}
                    </select>
                </form>
                {% endif %}
                <a href="/accounts" class="nav-link"
                    style="font-size: 0.9em; padding: 5px 10px; background: rgba(255,255,255,0.1); border-radius: 4px;">Manage
                    Accounts</a>
            </div>
        </div>
    </nav>

    <main class="container">
        {% block content %}{% endblock %}
    </main>

    <!-- GLOBAL DETAILS MODAL -->
    <div id="prospect-modal" class="modal-overlay" onclick="if(event.target === this) closeModal()">
        <div class="modal-content" style="width: 700px; max-width: 95%;">
            <button class="close-modal" onclick="closeModal()">&times;</button>

            <div class="modal-header" style="align-items: flex-start;">
                <img id="m-photo" src="" alt="Profile" class="modal-img"
                    style="width: 100px; height: 100px; border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div class="modal-info" style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <h2 id="m-name" style="margin: 0;">Loading...</h2>
                        <span id="badge-premium" class="badge-icon" title="Premium" style="display:none;">üíé</span>
                        <span id="badge-verified" class="badge-icon" title="Verified" style="display:none;">‚úÖ</span>
                        <span id="badge-creator" class="badge-icon" title="Creator" style="display:none;">üé®</span>
                    </div>

                    <p id="m-headline" style="margin-top: 5px; font-size: 1.1rem; color: #333;"></p>

                    <p id="m-location-container" style="font-size:0.9rem; color:#666; margin-top:5px; display:none;">
                        üìç <span id="m-location"></span>
                    </p>

                    <div id="m-stats-bar"
                        style="display: flex; gap: 15px; margin-top: 10px; font-size: 0.85rem; color: #555; background: #f8f9fa; padding: 8px 12px; border-radius: 8px; width: fit-content;">
                        <span id="stat-connections" title="Connections">üë• <b>-</b> Conn</span>
                        <span style="border-left: 1px solid #ddd;"></span>
                        <span id="stat-followers" title="Followers">üì¢ <b>-</b> Foll</span>
                        <span style="border-left: 1px solid #ddd;"></span>
                        <span id="stat-exp" title="Total Experience">bs <b>-</b> Yrs Exp</span>
                    </div>

                    <p id="m-contact-container" style="font-size:0.85rem; color:#555; margin-top:10px; display:none;">
                        <span id="m-email-box" style="margin-right:15px; display:none;">üìß <a id="m-email" href="#"
                                style="color:#1976d2; text-decoration:none;"></a></span>
                        <span id="m-phone-box" style="display:none;">üìû <span id="m-phone"></span></span>
                    </p>
                </div>
            </div>

            <div class="modal-body">
                <div class="modal-section">
                    <h3>About</h3>
                    <div id="m-about" class="modal-text"></div>
                </div>

                <div class="modal-section">
                    <h3>Experience</h3>
                    <div id="m-experience"></div>
                </div>

                <div class="modal-section" id="sec-skills">
                    <h3>Skills</h3>
                    <div id="m-skills" style="display:flex; flex-wrap:wrap;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- GLOBAL STYLES FOR MODAL -->
    <style>
        .badge-icon {
            font-size: 1.2rem;
            cursor: help;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 600px;
            max-width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            padding: 25px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .modal-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
        }

        .modal-info h2 {
            margin: 0 0 5px 0;
            font-size: 1.5rem;
        }

        .modal-info p {
            margin: 0;
            color: #666;
            font-size: 0.95rem;
        }

        .modal-section {
            margin-bottom: 30px;
        }

        .modal-section h3 {
            font-size: 0.9rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #eee;
            display: block;
            margin-bottom: 15px;
            padding-bottom: 5px;
            font-weight: 600;
        }

        .modal-text {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
        }

        .skill-tag {
            display: inline-block;
            background: #f1f3f4;
            color: #333;
            padding: 5px 12px;
            border-radius: 16px;
            font-size: 0.85rem;
            margin: 4px;
            border: 1px solid #e0e0e0;
        }

        /* Experience Card Style */
        .exp-item {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f9f9f9;
        }

        .exp-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 4px;
            background: white;
            border: 1px solid #eee;
            flex-shrink: 0;
        }

        .exp-details {
            flex: 1;
        }

        .exp-title {
            font-weight: 700;
            color: #202124;
            font-size: 1rem;
        }

        .exp-company {
            font-weight: 500;
            color: #1976d2;
            /* Link color */
            font-size: 0.95rem;
            text-decoration: none;
        }

        .exp-company:hover {
            text-decoration: underline;
        }

        .exp-meta {
            font-size: 0.85rem;
            color: #666;
            margin-top: 2px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .exp-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .exp-desc {
            font-size: 0.9rem;
            color: #444;
            margin-top: 8px;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #aaa;
            background: none;
            border: none;
        }

        .close-modal:hover {
            color: #333;
        }
    </style>

    <script>
        async function openModal(id) {
            const modal = document.getElementById('prospect-modal');

            // Reset fields
            document.getElementById('m-name').textContent = "Loading...";
            document.getElementById('m-headline').textContent = "";
            document.getElementById('m-photo').src = "";
            document.getElementById('m-about').textContent = "";
            document.getElementById('m-experience').innerHTML = "";
            document.getElementById('m-skills').innerHTML = "";

            // Hide specific elements
            document.getElementById('badge-premium').style.display = 'none';
            document.getElementById('badge-verified').style.display = 'none';
            document.getElementById('badge-creator').style.display = 'none';
            document.getElementById('m-location-container').style.display = 'none';
            document.getElementById('m-contact-container').style.display = 'none';
            document.getElementById('m-stats-bar').style.display = 'none';

            modal.style.display = 'flex';

            try {
                const res = await fetch(`/api/prospects/${id}`);
                const result = await res.json();

                if (!result.success) {
                    alert("Error loading prospect details.");
                    closeModal();
                    return;
                }
                const p = result.prospect;

                // 1. Header Info
                document.getElementById('m-name').textContent = p.name;
                document.getElementById('m-headline').textContent = p.headline || "";
                document.getElementById('m-photo').src = p.photo || ('https://ui-avatars.com/api/?name=' + p.name);

                // Badges
                if (p.is_premium) document.getElementById('badge-premium').style.display = 'inline-block';
                if (p.is_verified) document.getElementById('badge-verified').style.display = 'inline-block';
                if (p.is_creator) document.getElementById('badge-creator').style.display = 'inline-block';

                // Location
                if (p.location && p.location.trim() !== "") {
                    document.getElementById('m-location').textContent = p.location;
                    document.getElementById('m-location-container').style.display = 'block';
                }

                // Stats
                if (p.connections_count || p.followers_count || p.years_of_experience) {
                    document.getElementById('m-stats-bar').style.display = 'flex';
                    document.querySelector('#stat-connections b').textContent = p.connections_count ? p.connections_count.toLocaleString() : '-';
                    document.querySelector('#stat-followers b').textContent = p.followers_count ? p.followers_count.toLocaleString() : '-';
                    document.querySelector('#stat-exp b').textContent = p.years_of_experience ? p.years_of_experience + 'y' : '-';
                }

                // Contacts
                let hasContact = false;
                if (p.email && p.email.trim()) {
                    document.getElementById('m-email').textContent = p.email;
                    document.getElementById('m-email').href = "mailto:" + p.email;
                    document.getElementById('m-email-box').style.display = 'inline';
                    hasContact = true;
                }
                if (p.phone && p.phone.trim()) {
                    document.getElementById('m-phone').textContent = p.phone;
                    document.getElementById('m-phone-box').style.display = 'inline';
                    hasContact = true;
                }
                if (hasContact) document.getElementById('m-contact-container').style.display = 'block';

                // 2. About
                document.getElementById('m-about').textContent = p.about || "No description available.";

                // 3. Experience (Rich Display)
                const expContainer = document.getElementById('m-experience');
                let experiences = [];
                try {
                    if (p.experience) {
                        if (typeof p.experience === 'string' && p.experience.trim().startsWith('[')) {
                            experiences = JSON.parse(p.experience);
                        } else if (Array.isArray(p.experience)) {
                            experiences = p.experience;
                        } else {
                            // Fallback str
                        }
                    }
                } catch (e) { console.error("Exp parse error", e); }

                if (experiences.length > 0) {
                    experiences.forEach(exp => {
                        const div = document.createElement('div');
                        div.className = 'exp-item';

                        // Extract rich fields
                        const title = exp.title || "Unknown Role";
                        const company = exp.companyName || exp.company || "";
                        const companyUrl = exp.companyLink1 || exp.companyUrl || exp.companyWebsite || "#";
                        const logoUrl = exp.logo || "https://ui-avatars.com/api/?name=" + encodeURIComponent(company) + "&background=random";

                        const industry = exp.companyIndustry || p.industry || ""; // Fallback to profile industry if current
                        const size = exp.companySize || p.company_size || "";

                        const dateRange = (exp.jobStartedOn || "") + (exp.jobEndedOn ? " - " + exp.jobEndedOn : (exp.jobStillWorking ? " - Present" : ""));
                        const duration = exp.employmentType || ""; // Short description instead?
                        const location = exp.jobLocation || "";

                        div.innerHTML = `
                            <img src="${logoUrl}" class="exp-logo" onerror="this.src='https://ui-avatars.com/api/?name=${company}'">
                            <div class="exp-details">
                                <div class="exp-title">${title}</div>
                                <div>
                                    <a href="${companyUrl}" target="_blank" class="exp-company">${company}</a>
                                    ${industry ? `<span style="color:#888; font-size:0.85rem;"> ‚Ä¢ ${industry}</span>` : ''}
                                </div>
                                <div class="exp-meta">
                                    <span>üóìÔ∏è ${dateRange}</span>
                                    ${size ? `<span>üë• ${size}</span>` : ''}
                                    ${location ? `<span>üìç ${location}</span>` : ''}
                                </div>
                                ${exp.jobDescription ? `<div class="exp-desc">${exp.jobDescription}</div>` : ''}
                            </div>
                        `;
                        expContainer.appendChild(div);
                    });
                } else {
                    expContainer.innerHTML = `<div style="color:#777; font-style:italic;">${p.experience || "No experience info."}</div>`;
                }

                // 4. Skills
                const skillsContainer = document.getElementById('m-skills');
                const secSkills = document.getElementById('sec-skills');
                let skills = [];
                try {
                    if (p.skills) {
                        if (typeof p.skills === 'string' && p.skills.trim().startsWith('[')) {
                            const parsed = JSON.parse(p.skills);
                            skills = parsed.map(s => (typeof s === 'object' && s.title) ? s.title : s);
                        } else if (Array.isArray(p.skills)) {
                            skills = p.skills.map(s => (typeof s === 'object' && s.title) ? s.title : s);
                        } else {
                            skills = p.skills.split(/,|\n/).map(s => s.trim()).filter(s => s);
                        }
                    }
                } catch (e) { }

                if (skills.length > 0) {
                    skills.forEach(s => {
                        const span = document.createElement('span');
                        span.className = 'skill-tag';
                        span.textContent = s;
                        skillsContainer.appendChild(span);
                    });
                    secSkills.style.display = 'block';
                } else {
                    secSkills.style.display = 'none';
                }

            } catch (e) {
                console.error(e);
                alert("Network Error");
                closeModal();
            }
        }

        function closeModal() {
            document.getElementById('prospect-modal').style.display = 'none';
        }

        // --- MESSAGE MODAL ---
        function openMessageModal(text) {
            document.getElementById('msg-full-content').textContent = text;
            document.getElementById('message-modal').style.display = 'flex';
        }
        function closeMessageModal() {
            document.getElementById('message-modal').style.display = 'none';
        }
    </script>

    <!-- MESSAGE MODAL HTML -->
    <div id="message-modal" class="modal-overlay" onclick="if(event.target === this) closeMessageModal()">
        <div class="modal-content" style="width: 500px; max-width: 90%;">
            <button class="close-modal" onclick="closeMessageModal()">&times;</button>
            <h3 style="margin-top:0; color:#333; border-bottom:1px solid #eee; padding-bottom:10px;">Message Content
            </h3>
            <div id="msg-full-content"
                style="white-space: pre-wrap; margin-top: 15px; line-height: 1.6; color: #444; background: #f8f9fa; padding: 15px; border-radius: 8px; font-size: 0.95rem;">
            </div>
        </div>
    </div>

    <!-- Bottom Nav (Mobile Only) -->
    <nav class="bottom-nav">
        <a href="/" class="nav-item {{ 'active' if request.path == '/' else '' }}">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="/prospects" class="nav-item {{ 'active' if 'prospects' in request.path else '' }}">
            <i class="fas fa-users"></i>
            <span>Prospects</span>
        </a>
        <a href="/messages" class="nav-item {{ 'active' if 'messages' in request.path else '' }}">
            <i class="fas fa-comment-dots"></i>
            <span>Chat</span>
        </a>
        <a href="/campaigns" class="nav-item {{ 'active' if 'campaigns' in request.path else '' }}">
            <i class="fas fa-paper-plane"></i>
            <span>Camp.</span>
        </a>
        <a href="/settings" class="nav-item {{ 'active' if 'settings' in request.path else '' }}">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </a>
    </nav>

    <!-- JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>

</html>