{% extends "base.html" %}

{% block content %}
<div class="settings-page" style="max-width: 1000px; margin: 0 auto;">
    <h2>‚öôÔ∏è Settings (Updated Layout)</h2>

    <!-- Mobile Account Switcher -->
    <div class="mobile-show"
        style="background:white; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.05); border:1px solid #eee;">
        <h3 style="margin-top:0; font-size:1rem; margin-bottom:10px; color:#333;">üë§ Current Account</h3>
        {% if current_account %}
        <form action="/accounts/switch" method="POST" style="margin:0;">
            <select name="account_id" onchange="this.form.submit()"
                style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; background:white; font-size:1rem;">
                {% for acc in get_all_accounts() %}
                <option value="{{ acc.id }}" {% if current_account.id==acc.id %}selected{% endif %}>
                    {{ acc.name or acc.email }}
                </option>
                {% endfor %}
            </select>
        </form>
        <div style="margin-top:10px; text-align:right;">
            <a href="/accounts" style="font-size:0.9rem; color:#1976d2; text-decoration:none; font-weight:500;">Manage
                Connected Accounts ‚Üí</a>
        </div>
        {% endif %}
    </div>

    {% if saved %}
    <div style="background-color: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        ‚úÖ Settings saved successfully!
    </div>
    {% endif %}

    <!-- Account AI Settings -->

    {% if current_account %}
    <div class="card"
        style="width: 100%; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 30px; border-left: 5px solid #1976d2;">
        <h3>üîê Account Credentials for <span style="color: #1976d2;">{{ current_account.name }}</span></h3>
        <p style="color: #666; margin-bottom: 20px;">
            Configure session cookie and proxy settings for this account.
        </p>

        <form method="POST" action="/settings/account" style="display: block;">
            <div class="form-group" style="margin-bottom: 20px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">LinkedIn Session Cookie
                    (li_at)</label>
                <input type="text" name="li_at_cookie" value="{{ current_account.li_at_cookie or '' }}"
                    placeholder="li_at..."
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                <p style="font-size: 0.8em; color: #888; margin-top: 5px;">Required for automation. Refresh this if the
                    bot fails to login.</p>
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-weight: 600; margin-bottom: 5px;">Proxy Configuration</label>
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="proxy_enabled" name="proxy_enabled" {%
                            if current_account.proxy_enabled %}checked{% endif %}>
                        <label class="custom-control-label" for="proxy_enabled" style="font-size:0.9em;">Enable
                            Proxy</label>
                    </div>
                </div>

                <div style="display: flex; gap: 15px;">
                    <div style="flex: 2;">
                        <label style="font-size: 0.9em; margin-bottom: 5px; display: block;">Host:Port</label>
                        <input type="text" name="proxy_url" value="{{ current_account.proxy_url or '' }}"
                            placeholder="e.g. socks5://geo.iproyal.com:12345 or http://..."
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="flex: 1;">
                        <label style="font-size: 0.9em; margin-bottom: 5px; display: block;">Username</label>
                        <input type="text" name="proxy_username" value="{{ current_account.proxy_username or '' }}"
                            placeholder="user"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="flex: 1;">
                        <label style="font-size: 0.9em; margin-bottom: 5px; display: block;">Password</label>
                        <input type="password" name="proxy_password" value="{{ current_account.proxy_password or '' }}"
                            placeholder="pass"
                            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
            </div>


            <div style="margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 15px;">
                <label style="font-weight: 600; margin-bottom: 5px; display: block;">Custom User Agent
                    (Optional)</label>
                <input type="text" name="user_agent" value="{{ current_account.user_agent or '' }}"
                    placeholder="e.g. Mozilla/5.0 (Windows NT 10.0; Win64; x64)..."
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.9em;">
                <p style="font-size: 0.8em; color: #888; margin-top: 5px;">
                    Leave empty to use the default User-Agent (Firefox Linux). Use this to match your cookie's original
                    session environment.
                </p>
            </div>

            <div
                style="margin-top: 15px; display: flex; align-items: center; justify-content: space-between; border-top: 1px dashed #ddd; padding-top: 10px;">
                <div id="proxy_result_{{ current_account.id }}" style="font-size: 0.9rem; color: #666;">
                    <span style="opacity:0.7;">‚ÑπÔ∏è Save settings before testing.</span>
                </div>
                <button type="button" onclick="checkProxy({{ current_account.id }})"
                    style="background: #e3f2fd; color: #1976d2; border: 1px solid #1976d2; padding: 5px 15px; border-radius: 4px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                    üì° Test Proxy / IP
                </button>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button type="submit" class="btn-primary" style="padding: 10px 25px;">Save Account Settings</button>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Account AI Settings -->
    {% if current_account %}
    <div class="card"
        style="width: 100%; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 30px; border-left: 5px solid #1976d2;">
        <h3>ü§ñ Custom AI Prompt for <span style="color: #1976d2;">{{ current_account.name }}</span></h3>
        <p style="color: #666; margin-bottom: 20px;">
            Override the default prompt for this specific account. Leave empty to use the Default Configuration below.
        </p>
        <form method="POST" action="/settings/account" style="display: block;">
            <input type="hidden" name="update_prompt" value="true">
            <div class="form-group">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">System Prompt
                    (Personnalis√©)</label>
                <textarea name="system_prompt" rows="12" placeholder="You are a CEO..."
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; line-height: 1.4;">{{ current_account.system_prompt or '' }}</textarea>
                <p style="font-size: 0.8em; color: #888; margin-top: 5px;">Si vide, le prompt global ci-dessous sera
                    utilis√©.</p>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button type="submit" class="btn-primary" style="padding: 10px 25px;">Save Account Prompt</button>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Global Settings -->
    <div class="card"
        style="background: #f8f9fa; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e9ecef;">
        <h3>üåé Default Configuration (Fallback)</h3>
        <p style="color: #666; margin-bottom: 20px;">
            Customize the system prompt used by the AI to generate connection messages (applies to all accounts unless
            overridden).
        </p>

        <form method="POST" action="/settings" style="display: block;">
            <div class="form-group">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">System Prompt / Template</label>
                <p style="font-size: 0.85rem; color: #888; margin-bottom: 10px;">
                    This prompt is used for all accounts unless a custom prompt is defined above.
                    Use placeholders: <code>{name}</code>, <code>{headline}</code>, <code>{summary}</code>,
                    <code>{experience}</code>.
                </p>
                <textarea name="system_prompt" rows="12"
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; line-height: 1.4;">{{ system_prompt }}</textarea>
            </div>

            <div style="margin-top: 20px; text-align: right;">
                <button type="submit" class="btn-primary" style="padding: 10px 25px;">Save Global Prompt</button>
            </div>
        </form>
    </div>
</div>

<script>
    function promptRename(id, oldName) {
        const newName = prompt("Nouveau nom pour ce compte :", oldName);
        if (newName && newName !== oldName) {
            document.getElementById('renameAccountId').value = id;
            document.getElementById('renameAccountName').value = newName;
            document.getElementById('renameForm').submit();
        }
    }

    function openSecurityModal(accountId, settings) {
        if (typeof settings === 'string') {
            try { settings = JSON.parse(settings); } catch (e) { settings = {}; }
        }

        document.getElementById('secAccountId').value = accountId;

        // Defaults
        const timezone = settings.timezone || 'Europe/Paris';
        const working_hours = settings.working_hours || { start: '09:00', end: '18:00', days: [0, 1, 2, 3, 4] };
        const typing_speed = settings.typing_speed || { min: 50, max: 150 };
        const human_scroll = settings.human_scroll !== false; // Default true

        // Fill fields
        document.getElementById('secTimezone').value = timezone;
        document.getElementById('secStart').value = working_hours.start;
        document.getElementById('secEnd').value = working_hours.end;
        document.getElementById('secMinType').value = typing_speed.min;
        document.getElementById('secMaxType').value = typing_speed.max;
        document.getElementById('secScroll').checked = human_scroll;

        // Checkboxes days
        const days = working_hours.days || [];
        document.querySelectorAll('input[name="days"]').forEach(cb => {
            cb.checked = days.includes(parseInt(cb.value));
        });

        // Show modal
        document.getElementById('securityModal').style.display = 'block';
    }

    async function checkProxy(accountId) {
        const resultDiv = document.getElementById(`proxy_result_${accountId}`);
        resultDiv.innerHTML = '<span class="loading-spinner">üîÑ Checking IP...</span>';

        try {
            const res = await fetch(`/api/check_proxy/${accountId}`);
            const data = await res.json();

            if (data.success) {
                if (data.using_proxy) {
                    resultDiv.innerHTML = `
                        <span style="color: #2e7d32; font-weight: 600;">
                            ‚úÖ Proxy ACTIVE - ${data.ip} (${data.country})
                        </span>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <span style="color: #e65100; font-weight: 600;">
                            ‚ö†Ô∏è Proxy OFF (Direct IP) - ${data.ip} (${data.country})
                        </span>
                    `;
                }
            } else {
                resultDiv.innerHTML = `
                    <span style="color: #d32f2f; font-weight: 500;">
                        ‚ùå Connection Failed: ${data.error}
                    </span>
                `;
            }
        } catch (e) {
            resultDiv.innerHTML = '<span style="color: #d32f2f;">‚ùå Network Error</span>';
        }
    }


    function closeSecurityModal() {
        document.getElementById('securityModal').style.display = 'none';
    }

    // Fermer si click dehors
    window.onclick = function (event) {
        const modal = document.getElementById('securityModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
{% endblock %}